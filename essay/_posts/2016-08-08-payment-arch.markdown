---
layout: post
title: "支付系统架构"
subtitle: "支付系统设计-11"
date: 2016-08-08 12:00:00
author: "shamphone"
header-img: "img/home-bg-post.jpg"
catalog: true
tags: [Fintech]

---

> 修改记录：  
> 2016-08-08 初稿，列举了现有主流公司的支付架构；  
> 2017-03-04 补充支付系统架构的overview.

整体上来说，我们可以把一个公司的支付系统发展分为三个阶段：  
1. 支付系统：支付作为一个（封闭）的、独立的应用系统，为各系统提供支付功能支持。一般来说，这个系统仅限于为公司内部的业务提供支付支持，并且和业务紧密耦合。  
2. 支付服务：支付作为一个开放的系统，为公司内外部系统、各种业务提供支付服务。支付服务本身应该是和具体的业务解耦合的。   
3. 支付平台：支付作为一个可扩展的平台， 公司内外部的用户可以在此基础上定制开发自己的服务。  
简单说，支付系统是仅供内部使用的， 支付服务是支持公司内外部来调用的，支付平台是可以在服务的基础上定制各种场景支持的。 在实施上，一般也是按照这个顺序来逐步构建和完善。只有把支付系统做好了，才能在此基础上，开发支付服务；先用支付服务把公司内部的业务服务好，充分了解支付业务功能，才有基础建设好支付平台。

## 支付业务流程

区分两个概念:支付和交易。支付是交易的一部分。一个简单的交易过程包括:客户下订单，客户完成支付，商家接收订单，商家出货。这里仅考虑下订单的流程。从软件工程的角度， 我们首先需要明确下几个参与者。

- 电商系统，指提供在线购物服务的系统。用户在这个系统中完成交易。

- 支付系统，可以是电商系统的一个模块，或者是个独立的系统。这是本文的主角，用来完成支付过程。

- 用户，在电商系统中败家的那位。如果使用银行卡做交易，那也被称为持卡人。

- 用户使用银行卡交易时，发行这个银行卡的机构称为发卡行，或者发卡机构。

- 商家也需要一张卡，就是大家在淘宝开网店的时候要登记的银行卡，最终需要把用户给的钱打到这张卡上。

- 和发卡机构相对应的，大家听到最多的是收单机构。如支付宝，微信等第三方支付公司，介绍业务的时候总少不了互联网收单的工作。它们把用户订单收起来，找发卡行要钱，就有了收单业务。

主演都有了，下面就是如何演出支付这场大戏了。正常的流程应该是这样：


1. 用户提交订单到电商系统，电商系统对订单进行检验，无问题则调起支付接口执行支付。注意这里支付接口是在服务器端调起的。一般支付接口很少从客户端直接调起。为了安全，支付接口一般要求用HTTPS来访问，并对接口做签名。关于支付接口的设计，我将另起博文介绍。  
2.支付系统检查参数有效性，特别是签名的有效性。  
3.根据用户选择的支付方式，以及系统支付路由设置，选择合适的收单机构。这里涉及三个概念，支付方式，支付路由。这又是一个槽点。简单说，用户可以选择各种银行卡支付，比如宁波银行卡，但是你的支付系统没有对接宁波银行，那对这种卡，可以选择你接入的，支持这个卡的收单机构来执行支付，如用微信或者支付宝等等第三方支付，或者银联支付等系统支持的方式来执行。这就是支付路由，根据用户提供的银行卡来选择合适的收单机构去执行支付。常用支付方式还包括第三方支付，如微信支付宝等，这种情况下就不需要支付路由了。  
4.调用收单接口执行支付。这是支付系统的核心。每个公司的收单接口都不一样，接入一两个收单机构还好，接入的多了，如何统一这些接口，就是一个设计难点。  
5.支付成功，收单机构把钱打到商户的账户上了。 商家就准备发货了。 怎么发货，不是本文的重点。 这里关注的要点是， 商家能收到多少钱？ 比如100块钱的商品，用户支付了100块钱（运费、打折等另算），这100块钱，还要刨去电商系统的佣金、支付通道的手续费，才能最终落到商家手里。

这是个Happy流程，一切看起来都很美好，但实际上步步都是坑，一旦有地方考虑不周全，轻者掉单频发，重者接口被盗刷，损失惨重。  

- 如何避免攻击者修改支付接口参数， 比如100块钱的东西，改成10块钱？  
- 调用收单接口来执行最终实际支付时，如果支付失败了，比如卡上没钱了，怎么办？  
- 收单接口把账户上的钱扣走了，但是通知支付系统的时候出错了（比如网络闪断，或者支付系统重启了），支付系统不知道这笔交易已经达成了，怎么处理？  
- 还有好多问题....

和钱打交道，在任何公司，都跑不掉财务部门。 那财务部门会关注哪些内容？ 当然，最重要的是账务信息。 所有的交易都要记账，按要求公司都需要定期做审计，每一笔帐都不能出错。这当然不能等到审计的时候再去核对，而是每天都需要对账，确保所有的交易支出相抵，也就是所说的把账给平了。 这就有三种情况： 电商系统和商家对账；电商系统和支付系统对账；支付系统和收单机构对账。在支付系统中，我们仅关注后两者的情况。

从软件开发角度， 还有一些非功能性需求需要实现：
- 性能： 特别是秒杀的时候，如何满足高频率的支付需求？  
- 可靠性：不用说，系统能达到几个9，是衡量软件设计功力的重要指标。 99%是基础， 99.999%是目标，更多的9哪就是神了。  
- 易用性：支付中多一个步骤，就会流失至少2%的用户。 产品经理都在削尖脑袋想想怎么让用户赶紧掏钱。  
- 可扩展性： 近年来支付业务创新产品多，一元购、红包、打赏等，还有各种的支付场景。 怎么能够快速满足产品经理的需求，尽快上线来抢占市场，可扩展性对支付系统设计也是一个挑战。  
- 可伸缩性：为了支持公司业务，搞一些促销活动是必须的。 那促销带来的爆发流量，最佳应对方法就是加机器了。 平时流量低，用不了那么多机器，该释放的就释放掉了， 给公司省点钱。

## 支付的典型架构
所以支付的坑还不少，我们先看看互联网的头牌们是如何设计支付系统的？

**支持团购业务的支付系统**
[![某团支付系统产品架构](http://blog.lixf.cn/img/in-post/arch_meituan.png)](http://blog.lixf.cn/img/in-post/arch_meituan.png)

**支持旅游业务的支付系统**
[![Q旅游公司产品架构](http://blog.lixf.cn/img/in-post/arch_qunar.png)](http://blog.lixf.cn/img/in-post/arch_qunar.png)

**大型电商公司的支付系统架构**
[![某东金融产品架构](http://blog.lixf.cn/img/in-post/arch_jd.png)](http://blog.lixf.cn/img/in-post/arch_jd.png)

**支付宝公开的系统架构**
[![某金服产品架构](http://blog.lixf.cn/img/in-post/arch_alipay.png)](http://blog.lixf.cn/img/in-post/arch_alipay.png)


## 参考架构

一般来说，支付系统典型架构会包含如下模块：
[![模块设计](http://blog.lixf.cn/img/in-post/arch-modules.jpg)](http://blog.lixf.cn/img/in-post/arch-modules.jpg)


整体上来说， 从分层的角度，支付系统和普通的业务系统并没有本质的区别，也是应用、服务、接口、引擎、存储等分层。
在应用层，支付系统一般会提供如下子系统：

1. 支付应用和产品(应用层)： 这是针对各端（PC Web端、android、IOS)的应用和产品。 为各个业务系统提供收银台支持，同时支付作为一个独立的模块，可以提供诸如银行卡管理、理财、零钱、虚拟币管理、交易记录查阅、卡券等功能；

2. 支付运营系统(应用层)： 支付系统从安全的角度来说，有一个重要的要求是，懂代码的不碰线上，管运营的不碰代码。这对运营系统的要求就很高，要求基本上所有线上的问题，都可以通过运营系统来解决。

3. 支付BI系统(应用层): 支付中产生大量的数据，对这些数据进行分析， 有助于公司老板们了解运营状况，进行决策支持。

4. 风控系统(应用层)：这是合规要求的风险控制、反洗钱合规等。

5. 信用信息管理系统(应用层)：用来支持对信用算法做配置，对用户的信用信息做管理。

其他各层功能：

6. 支付服务层：为上述各端系统提供API。这些API也可以提供给业务系统直接使用。

7. 接口层：和各相关系统对接的接口，其中最重要的是和支付渠道对接的支付网关。

8. 引擎层： 包括统计分析、风控、反洗钱、信用评估等在后台运行的各个系统。

9. 存储层： 各种持久化的数据库支持。

这其实也是普通互联网应用系统架构，没有什么特别之处。比如微服务如何体现，如何满足性能需求等，在这个视图中无法体现出来。这只是个软件角度的高层视图，后续我们对各个主要模块进行分解，从分解视图中可以知道如何满足非功能性需求。